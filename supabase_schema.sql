-- 1. Create withdrawal_requests table (جدول طلبات السحب)
CREATE TABLE IF NOT EXISTS public.withdrawal_requests (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id bigint REFERENCES public.users(id),
    user_name text,
    amount numeric,
    bank_account text,
    status text DEFAULT 'pending',
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 2. Add affiliate columns to users table (أعمدة نظام العمولة)
-- This block checks if columns exist before adding them to avoid errors
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'affiliate_balance') THEN
        ALTER TABLE public.users ADD COLUMN affiliate_balance numeric DEFAULT 0;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'referred_by') THEN
        ALTER TABLE public.users ADD COLUMN referred_by bigint;
    END IF;
END $$;

-- 3. Enable RLS (تفعيل سياسات الأمان)
ALTER TABLE public.withdrawal_requests ENABLE ROW LEVEL SECURITY;

-- 4. Create Policy (فتح الصلاحيات للتطبيق)
-- We use a permissive policy here because authentication is handled via custom logic in the app
DROP POLICY IF EXISTS "Enable all access for all users" ON public.withdrawal_requests;

CREATE POLICY "Enable all access for all users" ON public.withdrawal_requests
FOR ALL USING (true) WITH CHECK (true);

-- 5. Grant permissions (منح الصلاحيات)
GRANT ALL ON TABLE public.withdrawal_requests TO anon;
GRANT ALL ON TABLE public.withdrawal_requests TO authenticated;
GRANT ALL ON TABLE public.withdrawal_requests TO service_role;
