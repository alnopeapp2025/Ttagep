-- Add Affiliate columns to users table
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS affiliate_balance numeric DEFAULT 0,
ADD COLUMN IF NOT EXISTS referred_by bigint REFERENCES public.users(id);

-- Create Withdrawal Requests table
CREATE TABLE IF NOT EXISTS public.withdrawal_requests (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id bigint REFERENCES public.users(id) NOT NULL,
    user_name text,
    amount numeric NOT NULL,
    bank_account text NOT NULL,
    status text DEFAULT 'pending', -- pending, completed
    created_at timestamptz DEFAULT now()
);

-- Policy to allow users to insert withdrawal requests
ALTER TABLE public.withdrawal_requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can insert their own requests" ON public.withdrawal_requests
    FOR INSERT WITH CHECK (true);

CREATE POLICY "Users can view their own requests" ON public.withdrawal_requests
    FOR SELECT USING (true);
